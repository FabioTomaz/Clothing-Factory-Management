CREATE DATABASE [GESTAO-FABRICA-VESTUARIO-LABORAL];
GO

CREATE TABLE CLIENTE(
	NIF					CHAR(9)			PRIMARY KEY CHECK(NIF>0),
	NOME				VARCHAR(50)		NOT NULL,
	PAIS				VARCHAR(30)		NOT NULL,
	NIB					CHAR(21)		UNIQUE NOT NULL,
	EMAIL				VARCHAR(30)		UNIQUE NOT NULL,
	TELEMOVEL			INT             UNIQUE NOT NULL CHECK(TELEMOVEL>0),
	RUA					VARCHAR(30)		NOT NULL,
	LOCALIDADE			VARCHAR(20)		NOT NULL,
	COD_POSTAL			CHAR(8)			NOT NULL
);
CREATE TABLE [FABRICA-FILIAL](
	N_FILIAL			INT				PRIMARY KEY	IDENTITY(1,1),
	EMAIL				VARCHAR(50)		UNIQUE	NOT NULL,
	TELEFONE			INT				UNIQUE	NOT NULL CHECK(TELEFONE>0),
	FAX					INT				UNIQUE	CHECK(FAX>0),
	LOCALIDADE			VARCHAR(30)		NOT NULL,
	CODPOSTAL			VARCHAR(10)		NOT NULL,
	RUA					VARCHAR(40)		NOT NULL,
	PAIS				VARCHAR(20)		NOT NULL
);

CREATE TABLE UTILIZADOR(
	N_FUNCIONARIO		INT				PRIMARY KEY	CHECK(N_FUNCIONARIO>0),
	EMAIL				VARCHAR(40)		UNIQUE	NOT NULL,
	SALARIO				INT				NOT NULL CHECK(SALARIO>=0),
	NOME				VARCHAR(50)		NOT NULL,
	PASSWORD			VARCHAR(15)		UNIQUE	NOT NULL,
	N_FABRICA			INT				REFERENCES [FABRICA-FILIAL](N_FILIAL),
	HORA_ENTRADA		TIME			NOT NULL,
	HORA_SAIDA			TIME			NOT NULL,
	CHECK(HORA_ENTRADA > HORA_SAIDA)	
);

CREATE TABLE [GESTOR_R_HUMANOS](
	N_FUNCIONARIO		INT				PRIMARY KEY	REFERENCES UTILIZADOR(N_FUNCIONARIO)
);
CREATE TABLE [GESTOR_ARMAZEM](
	N_FUNCIONARIO		INT				PRIMARY KEY	REFERENCES UTILIZADOR(N_FUNCIONARIO)
);

CREATE TABLE [GESTOR_VENDA](
	N_FUNCIONARIO		INT				PRIMARY KEY	REFERENCES UTILIZADOR(N_FUNCIONARIO)
);

CREATE TABLE [GESTOR_PRODUÇAO](
	N_FUNCIONARIO		INT				PRIMARY KEY	REFERENCES UTILIZADOR(N_FUNCIONARIO)
);

CREATE TABLE ENCOMENDA(
	N_ENCOMENDA			INT 			IDENTITY(1,1) PRIMARY KEY,
	DATA_CONFIRMACAO	DATETIME		NOT NULL,
	DATA_ENTREGA		DATETIME,
	LOCALENTREGA		VARCHAR(30),
	DESCONTO			DECIMAL(5,2)	DEFAULT 0.00 CHECK(DESCONTO>0),
	ESTADO				VARCHAR(15)		NOT NULL,
	NIF_CLIENTE			CHAR(9)			NOT NULL REFERENCES CLIENTE(NIF) ON UPDATE CASCADE,
	N_GESTOR_VENDA		INT				NOT NULL REFERENCES CLIENTE(NIF) ON UPDATE CASCADE
);

CREATE TABLE ETIQUETA(
	NUMERO_ETIQUETA		INT				PRIMARY KEY IDENTITY(1,1),
	NORMAS				VARCHAR(100)	NOT NULL,
	PAIS_FABRICO		VARCHAR(20)		NOT NULL,
	COMPOSIÇÃO			VARCHAR(100)	NOT NULL,
);
CREATE TABLE DESENHO(
	N_DESENHO			INT				PRIMARY KEY IDENTITY(1,1),
	DATA				DATE			NOT NULL,
	INTRUÇÕES_PRODUÇÃO	VARCHAR(100)	NOT NULL,
	CUSTO_ELETRICIDADE	DECIMAL(5,2),
	CUSTO_MAO_OBRA		DECIMAL(5,2),
	N_GESTOR_PROD		INT				NOT NULL REFERENCES [GESTOR_PRODUÇAO](N_FUNCIONARIO) ON UPDATE CASCADE,
	IMAGEM_DESENHO		VARCHAR(50)		NOT NULL,
	N_ETIQUETA			INT				REFERENCES  ETIQUETA(NUMERO_ETIQUETA) ON UPDATE CASCADE
);

CREATE TABLE DESENHO_PERSONALIZADO(
	N_DESENHO_PERS		INT				PRIMARY KEY IDENTITY(1,1),
	INTRUÇÕES_PRODUÇÃO	VARCHAR(100)	NOT NULL,
	--DEVERIA TMB O DESENHO PERSONALIZADO TER UM GERENTE DE PRODUÇÃO?
);

CREATE TABLE MODELO(
	N_MODELO			INT				IDENTITY(1,1),
	N_DESENHO			INT				REFERENCES DESENHO(N_DESENHO),
	PRIMARY KEY(N_MODELO, N_DESENHO)
);

CREATE TABLE PRODUTO(
	REFERENCIA			INT				CHECK(REFERENCIA>0) IDENTITY(1,1),
	TAMANHO				VARCHAR(5)		,
	COR					VARCHAR(15)		,
	PRECO				DECIMAL(7,2)	NOT NULL CHECK(PRECO>=0),
	IVA					DECIMAL(5,2)	NOT NULL DEFAULT 23.00,
	UNIDADES_ARMAZEM	INT				NOT NULL CHECK(UNIDADES_ARMAZEM>0) DEFAULT 1,
	N_MODELO			INT				NOT NULL,
	N_DESENHO			INT				NOT NULL,
	N_FABRICA			INT				NOT NULL REFERENCES [FABRICA-FILIAL](N_FILIAL),
	FOREIGN KEY ( N_MODELO, N_DESENHO )	REFERENCES MODELO( N_MODELO, N_DESENHO ),
	PRIMARY KEY(REFERENCIA, TAMANHO, COR)
);

CREATE TABLE CONTEUDO_ENCOMENDA(
	N_ENCOMENDA			INT				CHECK(N_ENCOMENDA>0) REFERENCES ENCOMENDA(N_ENCOMENDA),
	REFERENCIA_PRODUTO	INT				CHECK(REFERENCIA_PRODUTO>0),
	TAMANHO_PRODUTO		VARCHAR(5)		,
	COR_PRODUTO			VARCHAR(15)		,
	QUANTIDADE			INT				NOT NULL CHECK(QUANTIDADE>0) DEFAULT 1,
	FOREIGN KEY(REFERENCIA_PRODUTO, TAMANHO_PRODUTO, COR_PRODUTO) REFERENCES PRODUTO(REFERENCIA, TAMANHO, COR),
	PRIMARY KEY(N_ENCOMENDA, REFERENCIA_PRODUTO, TAMANHO_PRODUTO, COR_PRODUTO)
);

CREATE TABLE FORNECEDOR(
	NIF					INT				PRIMARY KEY CHECK(NIF>0),
	EMAIL				VARCHAR(50)		NOT NULL UNIQUE,
	NOME				VARCHAR(20)		NOT NULL UNIQUE,
	FAX					INT				CHECK (FAX>0),
	TELEFONE			INT				CHECK (TELEFONE>0),
	DESIGNAÇAO			VARCHAR(100)	,
	LOCALIDADE			VARCHAR(20)		NOT NULL,
	COD_POSTAL			CHAR(8)			NOT NULL,
	RUA					VARCHAR(30)		NOT NULL,
	PAIS				VARCHAR(30)		NOT NULL
);

CREATE TABLE BORDADO(
	N_MODELO			INT				CHECK(N_MODELO>0),
	N_DESENHO			INT				CHECK(N_DESENHO>0),
	DESIGNACAO			VARCHAR(100)	NOT NULL,
	IMAGEM				VARCHAR(50)		,
	PRECO				DECIMAL(10,2)	NOT NULL CHECK(PRECO>0),
	LOCALIZACAO			VARCHAR(20)		NOT NULL,
	NIF_FORNECEDOR		INT				NOT NULL REFERENCES FORNECEDOR(NIF) ON UPDATE CASCADE,
	QUALIDADE			INT				NOT NULL CHECK(QUALIDADE>0 AND QUALIDADE<=3),
	FOREIGN KEY ( N_MODELO, N_DESENHO )	REFERENCES MODELO( N_MODELO, N_DESENHO ),
	PRIMARY KEY(N_DESENHO, N_MODELO)
);

CREATE TABLE ESTAMPAGEM(
	N_MODELO			INT				,
	N_DESENHO			INT				,
	DESIGNACAO			VARCHAR(100)	NOT NULL,
	IMAGEM				VARCHAR(50)		,
	PRECO				DECIMAL(10,2)	NOT NULL CHECK(PRECO>0),
	LOCALIZACAO			VARCHAR(20)		NOT NULL,
	NIF_FORNECEDOR		INT				NOT NULL REFERENCES FORNECEDOR(NIF) ON UPDATE CASCADE,
	METODO				VARCHAR(30)		NOT NULL 
	FOREIGN KEY ( N_MODELO, N_DESENHO )	REFERENCES MODELO( N_MODELO, N_DESENHO ),
	PRIMARY KEY(N_DESENHO, N_MODELO)
);


CREATE TABLE MATERIAIS_TÊXTEIS(
	REFERENCIA_FABRICA	INT				PRIMARY KEY	CHECK (REFERENCIA_FABRICA > 0),
	REFERENCIA_FORN		INT				NOT NULL	CHECK (REFERENCIA_FORN>0),
	NIF_FORNECEDOR		INT				NOT NULL	REFERENCES FORNECEDOR(NIF),
	COR					VARCHAR(20)		NOT NULL,
	DESIGNAÇÃO			VARCHAR(80)		NOT NULL,
);

CREATE TABLE PANO(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES MATERIAIS_TÊXTEIS(REFERENCIA_FABRICA),
	TIPO				VARCHAR(20),
	GRAMAGEM			VARCHAR(20),
	AREA_ARMAZEM		DECIMAL(10,2)	CHECK (AREA_ARMAZEM>=0)	DEFAULT 0,
	PREÇO_POR_M2		DECIMAL(10,2)	NOT NULL
);

CREATE TABLE LINHA(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES MATERIAIS_TÊXTEIS(REFERENCIA_FABRICA),
	GROSSURA			INT,
	COMPRIMENTO_ARMAZEM	DECIMAL(10,2)	DEFAULT 0.00,
	PRECO_CEM_METROS	DECIMAL(10,2)	NOT NULL
);

CREATE TABLE ACESSÓRIOS_COSTURA(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES MATERIAIS_TÊXTEIS(REFERENCIA_FABRICA),
	QUANTIDADE_ARMAZEM	INT				DEFAULT 0,
	PREÇO_UNIDADE		DECIMAL(10,2)	NOT NULL
);

CREATE TABLE FECHO(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES ACESSÓRIOS_COSTURA(REFERENCIA_FABRICA),
	COMPRIMENTO			DECIMAL(10,2)	NOT NULL,
	TAMANHO_DENTE		DECIMAL(10,2)
);

CREATE TABLE MOLA(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES ACESSÓRIOS_COSTURA(REFERENCIA_FABRICA),
	DIAMETRO			DECIMAL(10,2)	NOT NULL
);

CREATE TABLE BOTAO(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES ACESSÓRIOS_COSTURA(REFERENCIA_FABRICA),
	DIAMETRO			DECIMAL(10,2)	NOT NULL
);
CREATE TABLE ELASTICO(
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES ACESSÓRIOS_COSTURA(REFERENCIA_FABRICA),
	LARGURA				INT				NOT NULL,
	COMPRIMENTO			INT				NOT NULL
);
CREATE TABLE [FITA-VELCRO](
	REFERENCIA_FABRICA	INT				PRIMARY KEY REFERENCES ACESSÓRIOS_COSTURA(REFERENCIA_FABRICA),
	LARGURA				INT				NOT NULL,
	COMPRIMENTO			INT				NOT NULL
);

CREATE TABLE [MATERIAIS-DESENHO](
	N_DESENHO			INT				,
	N_MODELO			INT				,
	REFERENCIA_FABRICA	INT				REFERENCES MATERIAIS_TÊXTEIS(REFERENCIA_FABRICA),
	QUANTIDADE			INT				NOT NULL CHECK(QUANTIDADE>=0),
	FOREIGN KEY ( N_MODELO, N_DESENHO )	REFERENCES MODELO( N_MODELO, N_DESENHO ),
	PRIMARY KEY(N_DESENHO, N_MODELO, REFERENCIA_FABRICA)
);

ALTER TABLE UTILIZADOR ADD N_FUNCIONARIO_SUPER	INT	REFERENCES [GESTOR_R_HUMANOS](N_FUNCIONARIO);